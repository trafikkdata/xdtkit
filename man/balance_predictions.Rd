% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/model_balancing.R
\name{balance_predictions}
\alias{balance_predictions}
\title{Balance traffic predictions using flow conservation constraints}
\usage{
balance_predictions(
  data,
  nodes,
  balancing_grouping_variable,
  nodes_to_balance = "complete_nodes",
  heavy_vehicle = FALSE,
  year
)
}
\arguments{
\item{data}{A data frame containing traffic link data with columns for traffic volumes,
predictions, and standard deviations. Must include `id` and `parentTrafficLinkId`.}

\item{nodes}{A data frame of network nodes used to build the incidence matrix for
flow conservation constraints.}

\item{balancing_grouping_variable}{Either a character string specifying a column name
in `data` for grouping, "run_clustering" to perform strategic network clustering,
"no_clustering" to treat all data as one group, or a data frame with cluster
assignments containing columns `id` and `cluster_id`.}

\item{nodes_to_balance}{Character string specifying which nodes to include in flow
balancing. Default is "complete_nodes".}

\item{heavy_vehicle}{Logical indicating whether to process heavy vehicle AADT
(TRUE) or total AADT (FALSE). Default is FALSE.}

\item{year}{Integer specifying the current year for calculating measurement error
based on data age.}
}
\value{
A list with two elements:
  \item{balanced_res}{A data frame with balanced predictions containing columns
    `id`, `nduplicates`, `balanced_pred` (or `balanced_pred_heavy`), and
    `balanced_sd` (or `balanced_sd_heavy`).}
  \item{diagnostics}{A list containing diagnostic information including measurement
    standard deviations, predictions by group, and group-specific diagnostics and
    incidence matrices.}
}
\description{
This function applies a two-stage Bayesian approach to traffic volume predictions.
It takes initial INLA predictions and applies flow conservation constraints at
intersections, along with measurement error modeling, to produce balanced predictions
that respect network flow properties.
}
\details{
The function implements a Bayesian updating approach where:
\itemize{
  \item Initial predictions from INLA serve as the prior
  \item Flow conservation constraints (incoming = outgoing traffic at nodes) are enforced
  \item Measurement error is calculated based on data source, coverage, and age
  \item Groups are processed independently and results are combined
  \item Duplicate predictions (from overlapping clusters) are averaged with combined uncertainty
}

The measurement error variance represents sensor/temporal uncertainty rather than
total observed variance, and is calculated using `calculate_measurement_error()`.
}
\seealso{
\code{\link{balance_group_predictions}}, \code{\link{calculate_measurement_error}},
  \code{\link{strategic_network_clustering}}
}
