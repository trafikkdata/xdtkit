% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/model_balancing.R
\name{balance_group_predictions}
\alias{balance_group_predictions}
\title{Balance predictions for a single group with flow conservation}
\usage{
balance_group_predictions(
  data,
  nodes,
  model = NULL,
  pred = NULL,
  sd = NULL,
  constraint_matrix = NULL,
  colname_aadt = "heavyAadt",
  colname_measurement_sd = "sigma_error",
  lambda = 1e-10,
  nodes_to_balance
)
}
\arguments{
\item{data}{A data frame containing traffic link data for a single group.}

\item{nodes}{A data frame of network nodes for building the incidence matrix.}

\item{model}{Optional INLA model object. If provided, predictions and standard
deviations are extracted from the model. Default is NULL.}

\item{pred}{Numeric vector of initial predictions. Required if `model` is NULL.}

\item{sd}{Numeric vector of prediction standard deviations. Required if `model` is NULL.}

\item{constraint_matrix}{Optional pre-built incidence matrix. If NULL, the matrix
is built using `build_incidence_matrix()`. Default is NULL.}

\item{colname_aadt}{Character string specifying the column name for observed AADT
values. Default is "heavyAadt".}

\item{colname_measurement_sd}{Character string specifying the column name for
measurement error standard deviations. Default is "sigma_error".}

\item{lambda}{Numeric regularization parameter for ill-conditioned systems.
Default is 1e-10.}

\item{nodes_to_balance}{Character string specifying which nodes to balance.}
}
\value{
A list with three elements:
  \item{results}{A data frame with columns `inla_pred`, `inla_sd`, `balanced_pred`,
    and `balanced_sd` containing both initial and balanced predictions.}
  \item{diagnostics}{A list containing:
    \itemize{
      \item `method_used`: "standard", "regularized", or "pseudoinverse"
      \item `rank_deficit`: Number of dependent constraints
      \item `condition_number`: Condition number of the covariance matrix
      \item `n_measurements`: Number of observed AADT values
      \item `n_links`: Number of traffic links
      \item `n_constraints`: Number of flow conservation constraints
      \item `underdetermined`: Logical indicating if system is underdetermined
      \item `capped_count`: Number of variances capped to prevent numerical issues
      \item `below_zero_count`: Number of negative predictions set to zero
      \item `runtime`: Time elapsed during computation
    }}
  \item{matrices}{A list containing the incidence matrix `A1` and measurement
    matrix `A2`.}
}
\description{
Performs Bayesian updating on traffic volume predictions for a single network group,
enforcing flow conservation constraints at intersections and incorporating measurement
uncertainty. This is the core computational function called by `balance_predictions()`.
}
\details{
The function implements the Bayesian update formula:
\deqn{\boldsymbol{\mu}_{v|b} = \boldsymbol{\mu}_v + \boldsymbol{\Sigma}_{vb}\boldsymbol{\Sigma}_b^{-1}(\boldsymbol{b} - \boldsymbol{A}\boldsymbol{\mu}_v)}
\deqn{\boldsymbol{\Sigma}_{v|b} = \boldsymbol{\Sigma}_v - \boldsymbol{\Sigma}_{vb}\boldsymbol{\Sigma}_b^{-1}\boldsymbol{\Sigma}_{vb}^\top}

where the constraint system is \eqn{\boldsymbol{A}\boldsymbol{v} + \boldsymbol{\varepsilon} = \boldsymbol{b}}
with \eqn{\boldsymbol{A} = [\boldsymbol{A}_1; \boldsymbol{A}_2]} stacking flow conservation
and measurement constraints.

The function handles several numerical stability issues:
\itemize{
  \item Extreme variances are capped at 1e10
  \item Rank-deficient systems use pseudoinverse
  \item Ill-conditioned systems use regularization
  \item Negative predictions are set to zero
  \item Posterior variances are bounded below by 1e-6
}
}
\seealso{
\code{\link{balance_predictions}}, \code{\link{build_incidence_matrix}},
  \code{\link{build_measurement_matrix}}
}
\keyword{internal}
